[ ] NAME:Current Task List DESCRIPTION:Root task for conversation __NEW_AGENT__
-[ ] NAME:Implementar Sistema de Anulación de Facturas DESCRIPTION:Crear funcionalidad completa para anular facturas con validaciones de roles, notificaciones al administrador y manejo de pagos asociados. Usar término 'anulada' en lugar de 'cancelada'.
--[/] NAME:1. Análisis y Configuración de Roles DESCRIPTION:Revisar sistema de roles actual, definir permisos para anulación (solo administrador y propietario), y crear middleware de autorización.
---[x] NAME:1.1 Definir Permisos de Anulación DESCRIPTION:Definir que solo roles 'administrador' y 'propietario' pueden anular facturas. Operadores (cajero, contralor, contador) no tendrán acceso.
---[/] NAME:1.2 Crear Middleware de Autorización DESCRIPTION:Crear middleware 'CanVoidInvoices' para validar permisos de anulación antes de permitir la acción.
---[ ] NAME:1.3 Actualizar Modelo User DESCRIPTION:Agregar métodos helper en User model para verificar permisos: canVoidInvoices(), isAdmin(), isOwner().
--[ ] NAME:2. Modelo y Lógica de Negocio DESCRIPTION:Implementar métodos de anulación en modelos Invoice y Payment con validaciones robustas y manejo transaccional.
---[ ] NAME:2.1 Método de Anulación en Invoice DESCRIPTION:Crear método voidInvoice() en modelo Invoice con validaciones: solo facturas 'issued' o 'debt', manejo de pagos asociados, cambio de estado a 'cancelled'.
---[ ] NAME:2.2 Método de Anulación en Payment DESCRIPTION:Crear método voidPayment() en modelo Payment para anular pagos asociados y recalcular estado de factura.
---[ ] NAME:2.3 Validaciones de Negocio DESCRIPTION:Implementar validaciones: facturas pagadas requieren confirmación especial, verificar integridad de datos, manejo transaccional con DB::transaction.
---[ ] NAME:2.4 Auditoría de Anulaciones DESCRIPTION:Agregar campos de auditoría: voided_at, voided_by, void_reason para rastrear quién y cuándo anuló.
--[ ] NAME:3. Sistema de Notificaciones DESCRIPTION:Crear sistema de notificaciones para alertar al administrador cuando se anule una factura (operación delicada).
---[ ] NAME:3.1 Crear Notificación de Anulación DESCRIPTION:Crear clase VoidInvoiceNotification para notificar al administrador cuando se anule una factura (operación delicada).
---[ ] NAME:3.2 Configurar Canales de Notificación DESCRIPTION:Configurar notificaciones por email y/o base de datos para alertas de anulación. Incluir detalles de factura y usuario que anuló.
---[ ] NAME:3.3 Identificar Administradores DESCRIPTION:Crear método para obtener usuarios administradores que deben recibir notificaciones de anulación.
--[ ] NAME:4. Controladores y Rutas DESCRIPTION:Crear métodos de anulación en controladores con validaciones de permisos y manejo de errores.
---[ ] NAME:4.1 Método void en InvoiceController DESCRIPTION:Crear método void() en InvoiceController con validaciones de permisos, confirmación de usuario y manejo de errores.
---[ ] NAME:4.2 Rutas de Anulación DESCRIPTION:Agregar rutas PATCH para anulación con middleware de autorización: /invoices/{invoice}/void y /payments/{payment}/void.
---[ ] NAME:4.3 Validación de Pagos Asociados DESCRIPTION:Implementar lógica para detectar pagos asociados y mostrar alerta antes de anular factura.
---[ ] NAME:4.4 Respuestas JSON para AJAX DESCRIPTION:Configurar respuestas JSON apropiadas para llamadas AJAX desde la interfaz de usuario.
--[ ] NAME:5. Interfaz de Usuario DESCRIPTION:Actualizar vistas con botones de anulación, modales de confirmación, alertas para pagos asociados y filtros por estado.
---[ ] NAME:5.1 Botón de Anulación DESCRIPTION:Agregar botón 'Anular Factura' en vista de detalle (show.blade.php) solo visible para administradores y propietarios.
---[ ] NAME:5.2 Modal de Confirmación DESCRIPTION:Crear modal de confirmación con campo para razón de anulación y advertencias sobre la operación.
---[ ] NAME:5.3 Alerta de Pagos Asociados DESCRIPTION:Mostrar alerta especial cuando la factura tenga pagos asociados, explicando que también se anularán.
---[ ] NAME:5.4 Filtro por Estado Anulada DESCRIPTION:Agregar opción 'Anuladas' en filtro de estado en index de facturas para mostrar facturas anuladas.
---[ ] NAME:5.5 Indicadores Visuales DESCRIPTION:Crear estilos CSS para mostrar facturas anuladas con color distintivo (rojo) y etiqueta 'ANULADA'.
--[ ] NAME:6. Testing y Validación DESCRIPTION:Crear tests para validar funcionalidad de anulación, permisos de roles y integridad de datos.
---[ ] NAME:6.1 Tests de Permisos DESCRIPTION:Crear tests para validar que solo administradores y propietarios pueden anular facturas. Verificar que operadores son rechazados.
---[ ] NAME:6.2 Tests de Lógica de Negocio DESCRIPTION:Crear tests para validar anulación de facturas con y sin pagos, recalculo de estados, y integridad transaccional.
---[ ] NAME:6.3 Tests de Notificaciones DESCRIPTION:Verificar que las notificaciones se envían correctamente a administradores cuando se anula una factura.
---[ ] NAME:6.4 Tests de Interfaz DESCRIPTION:Crear tests de interfaz para verificar que botones y modales aparecen correctamente según permisos de usuario.